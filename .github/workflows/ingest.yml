name: Ingest
on:
  workflow_dispatch:
  schedule:
    - cron: '0 14 * * *'

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Use Node.js 16
      uses: actions/setup-node@v1.4.4
      with:
        node-version: 16

    - run: yarn install

    - run: node ingest.js
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update kickstart checksum
      run: |
        docfile="docs/agent/packaging/installer/methods/kickstart.md"
        wget -O /tmp/kickstart.sh https://raw.githubusercontent.com/netdata/netdata/master/packaging/installer/kickstart.sh || exit 1
        checksum="$(md5sum /tmp/kickstart.sh | cut -d ' ' -f 1)"
        sed -e "s/^\[ \".*\" = \"\(.*\)$/[ \"${checksum}\" = \"\1/" "${docfile}" > tmp || exit 1
        mv tmp "${docfile}" || exit 1

    - name: Create pull request
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Ingest new documentation
        title: 'Ingest New Documentation'
        body: |
          - Ingest new documentation

          Auto-generated by [create-pull-request][1]

          [1]: https://github.com/peter-evans/create-pull-request:
        branch: ingest
        labels: ingest, automation
        # reviewers:
